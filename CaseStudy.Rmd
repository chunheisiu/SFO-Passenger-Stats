---
title: "BSDS 100 Case Study"
author: "Jacques Sham & Charles Siu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, include = F, warning = F}
library(tidyverse)
library(magrittr)
library(zoo)
library(ggplot2)
library(scales)
library(maps)
library(mapdata)
library(grid)
```

```{r init, include = F}
## Set the working dir according to who is working
if ("chunheisiu" %in% strsplit(getwd(), "/")[[1]]) {
  setwd("/Users/chunheisiu/Dropbox/Documents/USF/2018_Spring/BSDS_100/USF-BSDS100-CaseStudy")
} else {
  setwd("/Users/jacquessham/Documents/GitHub/USF-BSDS100-CaseStudy")
}

## Read the data
data <- read.csv("Air_Traffic_Passenger_Statistics.csv")
```

## Part 1: Executive Summary

!!DOTO: No more than 250 words explaining, with extreme concision, your data and findings!!


## Part 2: Introduction to the Data
First, let's clean the data.

```{r cleanup}
# Rename the column names
names(data) <- c("date", "operAirline", "operCode", "airline", "code", "isDomestic",
                 "region", "type", "category", "terminal", "area", "pax")

# Convert isDomestic to boolean
data$isDomestic %<>% recode("Domestic" = T, "International" = F)

# Reformat the dates into Date objects
data$date %<>% 
  as.character() %>% 
  as.yearmon("%Y%m") %>% 
  as.Date()

# Get month and year values
data %<>% 
  mutate(month = date %>% format("%m") %>% factor(labels = month.name),
         year = date %>% format("%Y") %>% as.numeric())

# Remove data from 2007 for easy comparison
data %<>% filter(year != 2005) 

## operAirline = Operating Airline, the airline that really operating, some airline would own a child company to operate a single route
## operCode = Operating Airline Code
## airline = Published Airline, mother company airline
## code = Published Airline Code, code for variable "airline"
## isDomestic: If the flight is domestic,T; if international: F
## region: Geom region
## type: activity type; Deplaned means arrival, Enplaned means departure, Thru / Transit is other 
## category: Airline price type; Low fare is Low cost carrier, else are others
## terminal: SFO terminal
## area: area within SFO terminal
## pax: passenger count of given row
```

```{r bar_graph}
data %>% 
  ggplot() +
  geom_bar(aes(x = year, y = pax / 1000000, fill = month), stat = "identity") +
  scale_x_continuous(name = "Year", breaks = seq(2006, 2017, by = 1)) +
  scale_y_continuous(name = "Passengers (Millions)") +
  scale_fill_discrete(name = "Month")
```

```{r map, fig.width = 10}
world <- map_data("world")
cities <- world.cities

remove_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )

# Derive the cities and corresponding regions
cities %<>%
  filter(
    (name == "Brisbane" & country.etc == "Australia") |
    (name %in% c("Topeka", "Yellowknife", "Tegucigalpa", "Port-au-Prince",
                       "Pontes e Lacerda", "Bambari", "Riyadh", "Mexico City",
                       "Shenzhen", "Ostrava"))
    ) %>% 
  mutate(region =
           ifelse(name == "Brisbane", "Australia / Oceania",
           ifelse(name == "Topeka", "US",
           ifelse(name == "Yellowknife", "Canada",
           ifelse(name == "Tegucigalpa", "Central America",
           ifelse(name == "Port-au-Prince", "Caribbean",
           ifelse(name == "Pontes e Lacerda", "South America",
           ifelse(name == "Bambari", "Africa",
           ifelse(name == "Riyadh", "Middle East",
           ifelse(name == "Mexico City", "Mexico",
           ifelse(name == "Shenzhen", "Asia",
           ifelse(name == "Ostrava", "Europe", NA)))))))))))
  ) %>% 
  full_join(y = data %>%
              mutate(region = as.character(region)) %>% 
              group_by(region, type) %>%
              summarize(pax = sum(pax)), by = "region")

sf <- world.cities %>%
  filter(name == "San Francisco" & country.etc == "USA")

# world %>% 
#   filter(region != "Antarctica") %>% 
#   ggplot() +
#   geom_polygon(aes(x = long, y = lat, group = group), fill = "darkgray") +
#   geom_curve(data = cities %>% filter(type == "Deplaned"), aes(x = long, y = lat, size = log(pax) / 100),
#              xend = sf$long, yend = sf$lat, color = "dodgerblue2", curvature = 0.5) +
#   geom_curve(data = cities %>% filter(type == "Enplaned"), aes(x = long, y = lat, size = log(pax) / 100),
#              xend = sf$long, yend = sf$lat, color = "mediumseagreen", curvature = -0.5) +
#   geom_point(x = sf$long, y = sf$lat, color = "red", size = 5) +
#   coord_fixed(1.3) +
#   theme_minimal() +
#   remove_axes +
#   guides(size = F)

world %>% 
  filter(region != "Antarctica") %>% 
  ggplot() +
  geom_polygon(aes(x = long, y = lat, group = group), fill = "darkgray") +
  geom_curve(data = cities %>% filter(type == "Deplaned"), aes(x = long, y = lat),
             xend = sf$long, yend = sf$lat, color = "dodgerblue2",
             curvature = 0.5, arrow = arrow(length = unit(0.025, "npc"))) +
  geom_curve(data = cities %>% filter(type == "Enplaned"), aes(xend = long, yend = lat),
             x = sf$long, y = sf$lat, color = "mediumseagreen",
             curvature = 0.5, arrow = arrow(length = unit(0.025, "npc"))) +
  geom_point(x = sf$long, y = sf$lat, color = "red", size = 3) +
  geom_text(aes(x = sf$long, y = sf$lat, label = "SFO"),
            hjust = 1, nudge_x = -5.5, color = "red", size = 3) +
  geom_point(data = cities, aes(x = long, y = lat), color = "black", size = 3) +
  geom_text(data = cities, aes(x = long, y = lat, label = region),
            hjust = 0, nudge_x = 3, nudge_y = -1, color = "black", size = 3) +
  coord_fixed(1.3) +
  theme_minimal() +
  remove_axes +
  guides(size = F)
```


