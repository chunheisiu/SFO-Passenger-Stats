---
title: "BSDS 100 Case Study"
author: "Jacques Sham & Charles Siu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include = F}
knitr::opts_chunk$set(echo = F)
knitr::opts_chunk$set(fig.width = 10)
```

```{r libraries, include = F, warning = F, message = F}
suppressMessages(library(tidyverse))
suppressMessages(library(magrittr))
library(zoo)
library(ggplot2)
library(scales)
library(maps)
library(mapdata)
library(grid)
library(treemapify)
```

```{r init, include = F}
## Set the working dir according to who is working
curr_wd <- strsplit(getwd(), "/")[[1]]
if ("chunheisiu" %in% curr_wd) {
  setwd("/Users/chunheisiu/Dropbox/Documents/USF/2018_Spring/BSDS_100/USF-BSDS100-CaseStudy")
} else if ("jacquessham" %in% curr_wd) {
  setwd("/Users/jacquessham/Documents/GitHub/USF-BSDS100-CaseStudy")
} else {
  wd <- readline(prompt = "You're not Jacques or Charles! Enter the path to the data: ")
  setwd(wd)
}

## Read the data
data <- suppressMessages(read_csv("Air_Traffic_Passenger_Statistics.csv"))
```

## Part 1: Executive Summary

!!DOTO: No more than 250 words explaining, with extreme concision, your data and findings!!


## Part 2: Introduction to the Data

```{r cleanup}
# First, let's clean the data.
# Rename the column names
names(data) <- c("date", "operAirline", "operCode", "airline", "code", "isDomestic",
                 "region", "type", "category", "terminal", "area", "pax")

# Drop operating airline and code columns since they are insignificant
data %<>%
  select(-c(operAirline, operCode))

# Convert isDomestic to boolean
data$isDomestic %<>% recode("Domestic" = T, "International" = F)

# Reformat the dates into Date objects
data$date %<>% 
  as.character() %>% 
  as.yearmon("%Y%m") %>% 
  as.Date()

# Get month and year values
data %<>% 
  mutate(month = date %>% format("%m") %>% factor(labels = month.name),
         year = date %>% format("%Y") %>% as.numeric())

# Remove data from 2005 for easy comparison
data %<>% filter(year != 2005)

data$region %<>% recode("Central America" = "Latin America",
                        "South America" = "Latin America")
data$category %<>% recode("Other" = "Full Service") 

## airline = Published Airline, mother company airline
## code = Published Airline Code, code for variable "airline"
## isDomestic: If the flight is domestic,T; if international: F
## region: Geom region
## type: activity type; Deplaned means arrival, Enplaned means departure, Thru / Transit is other 
## category: Airline price type; Low fare is Low cost carrier, else are others
## terminal: SFO terminal
## area: area within SFO terminal
## pax: passenger count of given row
```

```{r cleanup2}
## Need to clean up incorrect data
## Below has the list of low cost carrier
## https://www.icao.int/sustainability/Documents/LCC-List.pdf

# Merge "United Airlines - Pre 07/01/2013" to "United Airlines"
data$airline %<>% recode("United Airlines - Pre 07/01/2013" = "United Airlines")

# Remove the strip of "Emirates "
data$airline %<>% recode("Emirates " = "Emirates")

# Some airlines were wrongly identified in category
# Convert the below airlines to full service/Low Fare
full_svc_airline <- c("Air China", "Air India Limited", "Air New Zealand", "Air Pacific Limited dba Fiji Airways",
                      "Emirates", "United Airlines", "Virgin America", "Volaris Airlines", "Delta Air Lines",
                      "US Airways")

lcc_svc_airline <- c("XL Airways France", "WOW Air", "WestJet Airlines")

data %<>%
  mutate(cat_temp = ifelse(airline %in% full_svc_airline, "Full Service", 
                    ifelse(airline %in% lcc_svc_airline, "Low Fare", as.character(category)))) %>% 
  mutate(category = as.factor(cat_temp))

# Change terminal into factor
data %<>%
  mutate(terminal = factor(terminal, levels = c("Terminal 1", "Terminal 2", "Terminal 3", "International", "Other")))
```


### I. Overview
San Francisco is the 13th largest city in the United States and is the Pacific Gateway of the nation. The airport owned by this city is called San Francisco International Airport, SFO, located in the Northern part of San Mateo County, near Millbrae. SFO has operated since 1927 and the first international service started in 1946. The airport is the 2nd busiest airport in California, 7th busiest airport in the United States, and 23rd busiest airport in the world. At the same time, SFO received the a lot of awards from rating agencies, such as the 3rd Best Airport in North America in 2012 and 3rd Best Airport Worldwide in 2014 from SkyTrax. There are 3 domestic terminals and 1 international terminal to the massive flow of passengers travel to different part of the United States and the Globe. 

San Francisco government offers open source data on the detail information on the passenger and air traffic in SFO between 2006 and 2017. The data we downloaded from the San Francisco government includes destination or origin, airlines, terminals, and passenger count between July, 2005 and December, 2017. The data set consists `17960` rows and `10` columns.

The report is going to investigate the following facts about SFO:

1) Overall annual and monthly passengers count between 2006 and 2017

2) Passengers Count by regions

3) Passengers Count by airlines

4) Passengers traffic travelled by Low Cost Carrier

5) Passengers traffic in the airport terminals

6) Passengers Count in 1 selected domestic carrier and 1 selected international carrier

```{r global_vars}
million <- 1000000
```

```{r global_theme}
format_title <- theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold"))
format_legend_title <- theme(legend.title = element_text(face = "bold"))
```


#### Overall passenger traffic between 2006 and 2017

SFO is a busy airport and is a transpacific geteway in the West Coast of the United States, the passenger traffic is heavy. Below is the annual total passengers count in SFO.

```{r annual_pax_trend}
data %>% 
  ggplot() +
  geom_bar(aes(x = year, y = pax / million, fill = month), stat = "identity") +
  theme_minimal() +
  scale_x_continuous(name = "Year", breaks = seq(2006, 2017, by = 1)) +
  scale_y_continuous(name = "Passengers (Millions)") +
  scale_fill_discrete(name = "Month") +
  ggtitle("The Annual Passengers Count") +
  format_title +
  format_legend_title
```

```{r pax_data, echo = F}
pax_year <- data %>% 
              group_by(year) %>% 
              summarise(sumpax = sum(pax))
```

There are `r pax_year[12,2]` passengers traveled in SFO `2017` compared to `r pax_year[1,2]` in `2006`. We can see a upward trend on passengers count in SFO. We can confirm the trend by plotting the annual passenger growth rate in the below line chart.

```{r annual_growth_pax, warning = F, message = F}
growth_rate <- function(x){
  rate <- x/lag(x)-1
  return (rate)
}

growth_rate_year <- pax_year %>% 
                      mutate(growth = growth_rate(sumpax))



 growth_rate_year %>% 
  ggplot(aes(x = year, y = growth)) + 
  geom_line() +
  theme_minimal() +
  scale_x_continuous(name = "Year", breaks = seq(2007, 2017, by = 1)) +
  scale_y_continuous(name = "Growth Rate (%)", labels = percent) +
  ggtitle("The Annual Passengers Count") +
  format_title +
  format_legend_title
```
```{r section1_data, echo = F}
max_growth <- growth_rate_year %>% top_n(1,growth)
avg_growth <- paste(round(mean(growth_rate_year$growth,na.rm = T),4)*100,"%", sep="")
double_growth <- ceiling(70/(mean(growth_rate_year$growth,na.rm = T)*100))
```

Beside in `2009` SFO experienced a slow year in passenger growth, we can confirm SFO has a upward trend on passenger growth. `r max_growth[1,1]` is the year SFO experienced the strongest growth between `2006` and `2017`, with `r paste(round(max_growth[1,3])*100,"%", sep="")` growth. The average passenger growth in the period is `r avg_growth`. It will take `r double_growth` years after 2006 for SFO to double the passenger traffic, in `r 2006+double_growth`.

#### Average passenger traffic between 2006 and 2017

The airline industry is season-sensitive industry. It means the season effects significant influence the passenger traffic. Generally, summer and Christmas holidays are two major peak season in the airline industry. Therefore, SFO experiences higher passenger traffic in those periods.

Below is the bar chart of monthly average total passenger count of SFO between 2006 and 2017.

```{r average_month_pax}
data %>%
  group_by(isDomestic, month) %>%
  summarise(avg_pax = round(mean(pax), digit = 0)) %>% 
  ggplot(aes(x = factor(month, labels = month.abb), y = avg_pax, fill = isDomestic)) +
  geom_bar(stat = "identity", alpha = 0.8) +
  theme_minimal() +
  scale_y_continuous(labels = comma) + 
  scale_fill_discrete(name = "Destination", label = c("International","Domestic")) +
  labs(x = "Month", y = "Passengers") +
  ggtitle("Monthly Average Passengers Count") +
  geom_text(aes(label = format(avg_pax, big.mark = ",")), size = 2.75,
            position = position_stack(vjust = 0.5), colour = "white") +
  format_title +
  format_legend_title
```

As seen on the bar chart, `June`, `July`, `August`, `October`, `December` are the months that SFO experience relatively higher passenger traffic. Beside `October`, the other high-traffic months are in the summer or Christmas holiday seasons. Interestingly, summer is the only busiest period of international traveling in or out from SFO as `June`, `July`, `August` are the only months that SFO handles more than `12000` international travelers. 

Roughly 80% of passengers in SFO are domestic travelers.  


#### Activity Type

The data set provided by the San Francisco government has the statistic on airplanes departure, arrival, and transit. Departure and arrival means airplanes depart and arrive in SFO, respectively. Transit means the passengers connect through SFO with the same airplane and the same flight number (If a passenger transfer from one plane to a different plane does not qualify "Transit" in the dataset). In the below pie chart shows the airplane activities between 2006 and 2017.

```{r traffic_type}
total_traffic <- data %>%
  summarise(total_traffic = sum(pax)) %>% 
  as.numeric()

data %>%
  group_by(type) %>%
  summarise(traffic = sum(pax)) %>% 
  ggplot(aes(x = "", y = traffic, fill = type)) +
  geom_bar(width = 1 , stat = "identity") +
  geom_text(aes(x = 1, y = cumsum(traffic) - traffic / 2, label = percent(traffic / total_traffic))) +
  coord_polar(theta = "y") +
  theme_void() +
  scale_fill_brewer(palette = "Set2", name = "Activity Type", label = c("Arrival", "Departure", "Transit")) +
  ggtitle("Percentage of Airplane Activities") +
  format_title +
  format_legend_title
```

```{r pie_chart_explain}
transit_list <- data %>% filter(type=="Thru / Transit") %>% count(airline) %>% arrange(desc(n))
```

There is no suprise on the close to 50%-50% split on departure and arrival passengers in SFO. Part of the reason is that the domestic carriers tend not to operate transiting flight via SFO, the portion of transit flights in SFO becomes significantly small. The top three airlines offers transit flights are `r transit_list[1,1]`, `r transit_list[2,1]` and `r transit_list[3,1]`. At the same time, there are transit flighs operated by some foreign carriers such as Singapore Airlines' `Singapore - Hong Kong - San Francisco` route and China Southern Airlines' `Canton - Wuhan - San Francisco` route. Since SFO is the final destination of either route, therefore passengers traveled with those routes do not count toward `transit` flights. 

### II. Destination

As the bar chart on the monthly average passengers count shows that roughly `80%` of the SFO passengers are domestic passengers. One maybe interested the destination of the remaining `20%` travelers. The map below shows the passengers count in North America between `2006` and `2017`.

```{r map_setup}
# Load the world map and cities
world <- map_data("world")
cities <- world.cities

# Retrieve the information of SF
sf <- world.cities %>%
  filter(name == "San Francisco" & country.etc == "USA")

# Derive the cities and corresponding regions
cities %<>%
  filter(
    (name == "Adelaide" & country.etc == "Australia") |
    (name == "La Paz" & country.etc == "Bolivia") |
    (name %in% c("Saint Louis", "La Ronge",
                 "Riyadh", "Mexico City", "Shenzhen", "Ostrava"))
    ) %>% 
  mutate(region =
           ifelse(name == "Adelaide", "Australia / Oceania",
           ifelse(name == "Saint Louis", "US",
           ifelse(name == "La Ronge", "Canada",
           ifelse(name == "La Paz", "Latin America",
           ifelse(name == "Riyadh", "Middle East",
           ifelse(name == "Mexico City", "Mexico",
           ifelse(name == "Shenzhen", "Asia",
           ifelse(name == "Ostrava", "Europe", NA))))))))
  ) %>% 
  full_join(y = data %>%
              mutate(region = as.character(region)) %>% 
              group_by(region, type) %>%
              summarize(pax = sum(pax)), by = "region") %>% 
  mutate(
    origin.lat = ifelse(type == "Enplaned", sf$lat, lat),
    origin.long = ifelse(type == "Enplaned", sf$long, long),
    dest.lat = ifelse(type == "Enplaned", lat, sf$lat),
    dest.long = ifelse(type == "Enplaned", long, sf$long)
  ) %>% 
  filter(type != "Thru / Transit")

cities_na <- cities %>% filter(region %in% c("US", "Canada", "Mexico"))
cities_intl <- cities %>% filter(!(region %in% c("US", "Canada", "Mexico")))
```

```{r draw_map}
# Geom objects for drawing static objects
draw_sf_point <- geom_point(x = sf$long, y = sf$lat, color = "red", size = 3)

draw_na_sf_label <- geom_text(aes(x = sf$long, y = sf$lat, label = "SFO"),
                           hjust = 1, nudge_x = -2, color = "red", size = 3)

draw_intl_sf_label <- geom_text(aes(x = sf$long, y = sf$lat, label = "SFO"),
                           hjust = 1, nudge_x = -5, color = "red", size = 3)

draw_color_legend <- scale_color_discrete(name = "Activity Type",
                                          labels = c("Arriving SFO", "Departing SFO"))

draw_size_legend <- scale_size_continuous(trans = "log10", guide = F)

# Functions for drawing curves, points and labels
draw_flight_curve <- function(d) {
  geom_curve(data = d %>% filter(type %in% c("Deplaned", "Enplaned")),
                           aes(x = origin.long, y = origin.lat,
                               xend = dest.long, yend = dest.lat,
                               color = type, size = pax),
                           curvature = 0.5, lineend = "round",
                           alpha = 0.75, arrow = arrow(length = unit(0.025, "npc")))
}

draw_city_points <- function(d) {
  return (geom_point(data = d, aes(x = long, y = lat), color = "black", size = 3))
}

draw_na_city_labels <- geom_text(data = cities_na, aes(x = long, y = lat, label = region),
                              hjust = 0, nudge_x = 2, nudge_y = -0.5,
                              color = "black", size = 3)

draw_intl_city_labels <- geom_text(data = cities_intl, aes(x = long, y = lat, label = region),
                              hjust = 0, nudge_x = 3.5, nudge_y = -1,
                              color = "black", size = 3)

draw_na_enplaned_labels <- geom_label(data = cities_na %>% filter(type == ("Enplaned")),
                                  aes(x = long, y = lat, label = format(pax, big.mark = ","), color = type),
                                  hjust = 0, nudge_x = 2, nudge_y = -2.5, size = 3, show.legend = F)

draw_na_deplaned_labels <- geom_label(data = cities_na %>% filter(type == ("Deplaned")),
                                 aes(x = long, y = lat - 4, label = format(pax, big.mark = ","), color = type),
                                 hjust = 0, nudge_x = 2, nudge_y = -.75, size = 3, show.legend = F)

draw_intl_enplaned_labels <- geom_label(data = cities_intl %>% filter(type == ("Enplaned")),
                                  aes(x = long, y = lat, label = format(pax, big.mark = ","), color = type),
                                  hjust = 0, nudge_x = 3.5, nudge_y = -7, size = 3, show.legend = F)

draw_intl_deplaned_labels <-geom_label(data = cities_intl %>% filter(type == ("Deplaned")),
                                 aes(x = long, y = lat - 4, label = format(pax, big.mark = ","), color = type),
                                 hjust = 0, nudge_x = 3.5, nudge_y = -9.5, size = 3, show.legend = F)

format_theme <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank(),
  legend.position = "bottom",
  legend.background = element_rect(fill = "gray90", size = 0),
  legend.title = element_text(face = "bold")
  )
```

```{r draw_na_map, fig.height = 8}
world %>% 
  filter(region %in% c("USA", "Canada", "Mexico")) %>% 
  ggplot() +
  geom_polygon(aes(x = long, y = lat, group = group), fill = "darkgray") +
  draw_flight_curve(cities_na) +
  draw_city_points(cities_na) +
  draw_na_city_labels +
  draw_sf_point +
  draw_na_sf_label +
  draw_na_enplaned_labels +
  draw_na_deplaned_labels +
  coord_fixed(1.3) +
  theme_minimal() +
  draw_color_legend +
  draw_size_legend +
  scale_fill_brewer(palette = "Set2") +
  scale_x_continuous(limits = c(-170, -50)) +
  ggtitle("Passengers Count by North American Destinations") +
  format_theme +
  format_title
```

And the map below shows the passengers count on other regions outside North America between `2006` and `2017`.

```{r draw_intl_map, fig.height = 8}
world %>% 
  filter(region != "Antarctica") %>% 
  ggplot() +
  geom_polygon(aes(x = long, y = lat, group = group), fill = "darkgray") +
  draw_flight_curve(cities_intl) +
  draw_city_points(cities_intl) +
  draw_intl_city_labels +
  draw_sf_point +
  draw_intl_sf_label +
  draw_intl_enplaned_labels +
  draw_intl_deplaned_labels +
  coord_fixed(1.3) +
  theme_minimal() +
  draw_color_legend +
  draw_size_legend +
  scale_x_continuous(limits = c(-170, 200)) +
  scale_y_continuous(limits = c(-60, 90)) +
  ggtitle("Passengers Count by International Destinations") +
  format_theme +
  format_title
```

The map shows that `Asia` is the continent the most passengers flying from or to after the United States, followed by `Europe`. Surprisingly there are less passengers coming from or going to `Canada` and `Mexico` than they coming from or going to `Asia` or `Europe`, and the passenger traffic from or to `Latin America` is very little. 

### III. Airline Overview

There are a lot of airlines serving travelers in SFO. Below is the stacked line chart of the domestic passengers count by airlines.

```{r top5_dom_list}
# Filter the top 5 airlines by domestic passenger count
top5_dom_list <- data %>%
  filter(isDomestic) %>%
  group_by(airline) %>%
  summarise(total_pax = sum(pax)) %>%
  top_n(5, total_pax) %>%
  arrange(total_pax) %>% 
  select(-total_pax)

# Combine and compute the other airlines
other_dom_airline <- data %>% 
  filter(!(airline %in% top5_dom_list$airline)) %>% 
  group_by(year) %>% 
  summarise(sum = sum(pax)) %>% 
  mutate(airline = "Other Airlines") %>% 
  select(airline, year, sum)
```

```{r top5_dom_area}
data %>%
  group_by(airline, year) %>% 
  summarize(sum = sum(pax)) %>% 
  right_join(top5_dom_list, by = "airline") %>%
  ungroup() %>% 
  rbind(other_dom_airline) %>%
  rbind(data %>%
          group_by(airline) %>%
          right_join(top5_dom_list, by = "airline") %>%
          summarize(year = min(year) - 1) %>%
          filter(year == min(data$year)) %>%
          mutate(sum = 0)) %>% 
  mutate(airline = factor(airline, levels = rbind(top5_dom_list, "Other Airlines")$airline)) %>% 
  ggplot() +
  geom_area(aes(x = year, y = sum / million, fill = airline), alpha = 0.75) +
  scale_x_continuous(name = "Year", breaks = seq(min(data$year), max(data$year), by = 1)) +
  scale_y_continuous(name = "Passengers (Millions)") +
  scale_fill_brewer(name = "Airline", palette = "Set2") +
  theme_minimal() +
  ggtitle("Domestic Passengers Count by Airline") +
  format_title +
  format_legend_title
```

```{r dom_travel_info}
airline_dom_pax <- data %>%
                      filter(isDomestic) %>%
                      group_by(airline) %>%
                      summarise(total_pax = sum(pax))
                

top5_dom_pax <- airline_dom_pax %>% 
                  top_n(5, total_pax) %>% 
                  summarise(pax = sum(total_pax))

dom_pax <- airline_dom_pax %>% summarise(pax = sum(total_pax))

top5_dom_pax_num <- top5_dom_pax[1,1]
all_dom_pax <- dom_pax[1,1]
non_top5_dom_pax <- dom_pax[1,1] - top5_dom_pax[1,1]
top5_dom_portion<- paste(round(top5_dom_pax_num/all_dom_pax,4)*100,"%",sep="")
non_top5_dom_portion <- paste(round(non_top5_dom_pax/all_dom_pax,4)*100,"%",sep="")
```

The chart shows that a large portion of SFO travelers traveling by `r top5_dom_list[5,1]` as SFO is one of the hub of `r top5_dom_list[5,1]` in the West Coast. `r top5_dom_list[1,1]`, `r top5_dom_list[2,1]`(Recently Merged with `Alaska Airlines`), `r top5_dom_list[3,1]`, `r top5_dom_list[4,1]` are the other top 5 major carrier in SFO in passenger count. A large portion of travelers in SFO travel with those airlines, `r top5_dom_portion` of all travelers traveled with those airlines between `2006` and `2017`. 

Below is the stacked line chart of the international passengers count by airlines.

```{r top_intl_list}
# Filter the top 5 airlines by international passenger count
top5_intl_list <- data %>%
  filter(!isDomestic) %>%
  group_by(airline) %>%
  summarise(total_pax = sum(pax)) %>%
  top_n(5, total_pax) %>%
  arrange(total_pax) %>% 
  select(-total_pax)

# Combine and compute the other airlines
other_intl_airline <- data %>% 
  filter(!(airline %in% top5_intl_list$airline)) %>% 
  group_by(year) %>% 
  summarise(sum = sum(pax)) %>% 
  mutate(airline = "Other Airlines") %>% 
  select(airline, year, sum)
```

```{r top5_intl_area}
data %>%
  group_by(airline, year) %>% 
  summarize(sum = sum(pax)) %>% 
  right_join(top5_intl_list, by = "airline") %>%
  ungroup() %>% 
  rbind(other_intl_airline) %>%
  rbind(data %>%
          group_by(airline) %>%
          right_join(top5_intl_list, by = "airline") %>%
          summarize(year = min(year) - 1) %>%
          filter(year == min(data$year)) %>%
          mutate(sum = 0)) %>% 
  mutate(airline = factor(airline, levels = rbind(top5_intl_list, "Other Airlines")$airline)) %>% 
  ggplot() +
  geom_area(aes(x = year, y = sum / million, fill = airline), alpha = 0.75) +
  scale_x_continuous(name = "Year", breaks = seq(min(data$year), max(data$year), by = 1)) +
  scale_y_continuous(name = "Passengers (Millions)") +
  scale_fill_brewer(name = "Airline", palette = "Set3") +
  theme_minimal() +
  ggtitle("International Passengers Count by Airline") +
  format_title +
  format_legend_title
```

```{r intl_travel_info}
airline_intl_pax <- data %>%
                      filter(!isDomestic) %>%
                      group_by(airline) %>%
                      summarise(total_pax = sum(pax))
                

top5_intl_pax <- airline_intl_pax %>% 
                  top_n(5, total_pax) %>% 
                  summarise(pax = sum(total_pax))

intl_pax <- airline_intl_pax %>% summarise(pax = sum(total_pax))

all_intl_pax <- intl_pax[1,1]
non_top5_intl_pax <- intl_pax[1,1] - top5_intl_pax[1,1]
non_top5_intl_portion <- paste(round(non_top5_intl_pax/all_intl_pax,4)*100,"%",sep="")
```

`r top5_intl_list[4,1]` is largest foreign carrier operating international flights in SFO, serving flights between San Francisco and Vancouver, Victoria, Edmonton, Calgary, Toronto, and MontrÃ©al. The other major foreign carrier including `r top5_intl_list[3,1]`, `r top5_intl_list[1,1]`, and `r top5_intl_list[2,1]` from Frankfurt and Munich, Germany, London Heathrow, Britain, and Hong Kong, respectively.


A very large portion of international travelers not traveling with the top 5 airlines: `r non_top5_intl_portion`. The portion of international travelers not traveling with the top 5 airlines is significantly higher than the portion of domestic travelers not traveling with the top 5 airlines, which is `r non_top5_dom_portion`. The airline industry monopoly effect is more dominant in domestic flights than in the international flights.

```{r top_region}
top_area <- data %>%
  group_by(region, airline) %>%
  summarise(pax_flow = sum(pax)) %>%
  top_n(1, pax_flow)
```

###III. Low Cost Carrier vs Full Service Carrier

Due to the advance of avaition technology, the cost of air travel significantly decrease in the last 100 years. In the last 40 years, there are more 

```{r lcc_basic}
dom_lcc_plot <- data %>% 
              filter(isDomestic & 
                       category=="Low Fare" &
                       airline != "ATA Airlines" &
                       airline != "Allegiant Air" &
                       airline != "Servisair" &
                       airline != "Spirit Airlines" &
                       airline != "Trego Dugan Aviation") %>% 
              group_by(year,airline) %>% 
              summarise(sumpax = sum(pax)/1000000) %>% 
              arrange(desc(sumpax))

intl_lcc_plot <- data %>% 
                  filter(!isDomestic & 
                           category=="Low Fare" &
                           airline != "ATA Airlines" &
                           airline != "Servisair") %>% 
                  group_by(year, airline) %>% 
                  summarise(sumpax = sum(pax)) %>% 
                  arrange(desc(sumpax))

intl_lcc_plot_2017 <- data %>% 
                  filter(!isDomestic & 
                           category=="Low Fare" &
                           airline != "ATA Airlines" &
                           airline != "Servisair" &
                           year == 2017) %>% 
                  group_by(airline) %>% 
                  summarise(sumpax = sum(pax)) %>% 
                  arrange(desc(sumpax))
```


```{r domestic_lcc_linechart}
dom_lcc_plot %>% ggplot(aes(x = year, y = sumpax, group = airline, color = airline)) +
              geom_line() +
              labs(x = "Year", y = "Total Passenger Count") +
              scale_x_continuous(name = "Year", breaks = seq(min(data$year), max(data$year), by = 1)) +
              scale_y_continuous(name = "Passengers (Million)", breaks = seq(0,max(dom_lcc_plot$sumpax), by = 1))

```

```{r intl_lcc_linechart}
intl_lcc_plot %>% ggplot(aes(x = year, y = sumpax, fill = airline)) +
                    scale_fill_brewer(palette = "Spectral") +
                    geom_bar(stat = "identity") + 
                    scale_x_continuous(name = "Year", breaks = seq(min(data$year), max(data$year), by = 1)) +
                    scale_y_continuous(name = "Passengers", breaks = seq(0,500000,by=50000))

```

```{r intl_lcc_plot_2017}
total_intl_lcc_pax_2017 <- intl_lcc_plot_2017 %>%  summarise(total_pax = sum(sumpax))
total_intl_lcc_pax_2017 <- as.numeric(total_intl_lcc_pax_2017)

intl_lcc_plot_2017 %>%
  ggplot(aes(x = "", y = sumpax, fill = airline)) +
  geom_bar(width = 1 , stat = "identity") +
  geom_text(aes(x = 1, y = cumsum(sumpax) - sumpax / 2, label = percent(sumpax / total_intl_lcc_pax_2017))) +
  coord_polar(theta = "y") +
  theme_void() +
  scale_fill_brewer(palette = "Set2", name = "Airline") +
  ggtitle("Low Cost Carrier International Flight") +
  format_title +
  format_legend_title
```


### IV. Terminal Traffic

```{r terminal_domestic}
data %>%
  filter(isDomestic, !is.na(code)) %>%
  group_by(terminal, airline, code) %>%
  summarise(all_pax = sum(pax)) %>% 
  ggplot(aes(area = all_pax, fill = terminal, label = code, group = airline)) +
  geom_treemap() +
  geom_treemap_text(colour = "white", place = "centre") +
  scale_fill_brewer(name = "Terminal", palette = "Set2") +
  ggtitle("Domestic Passengers Count by Airline and Terminal") +
  format_title +
  format_legend_title
```

```{r terminal_international}
data %>%
  filter(!isDomestic, !is.na(code)) %>%
  group_by(terminal, airline, code) %>%
  summarise(all_pax = sum(pax)) %>% 
  ggplot(aes(area = all_pax, fill = terminal, label = code, group = airline)) +
  geom_treemap() +
  geom_treemap_text(colour = "white", place = "centre") +
  scale_fill_brewer(name = "Terminal", palette = "Set2") +
  ggtitle("International Passengers Count by Airline and Terminal") +
  format_title +
  format_legend_title
```


```{r terminal}
data %>%
  filter(!is.na(code)) %>%
  group_by(terminal, airline, code) %>%
  summarise(all_pax = sum(pax)) %>% 
  ggplot(aes(area = all_pax, fill = terminal, label = code, group = airline)) +
  geom_treemap() +
  geom_treemap_text(colour = "white", place = "centre") +
  scale_fill_brewer(name = "Terminal", palette = "Set2") +
  ggtitle("Passengers Count by Airline and Terminal") +
  format_title +
  format_legend_title
```

### VI. Airlines

```{r united}
data %>%
  filter(code == "UA") %>%
  group_by(month, year) %>%
  summarise(Passengers = sum(pax)) %>%
  ggplot(aes(x = factor(month, labels = month.abb), y = year)) +
  geom_tile(aes(fill = Passengers)) + 
  scale_x_discrete(name = "Month") +
  scale_y_continuous(expand = c(0, 0), name = "Year", breaks = seq(min(data$year), max(data$year), by = 1)) +
  scale_fill_gradientn(colours = rev(heat.colors(10)), labels = comma) +
  theme_minimal() +
  ggtitle("United Airlines Passengers Count") +
  format_title +
  format_legend_title
```

```{r cathay}
data %>%
  filter(code == "CX") %>%
  group_by(month, year) %>%
  summarise(Passengers = sum(pax)) %>%
  ggplot(aes(x = factor(month, labels = month.abb), y = year)) +
  geom_tile(aes(fill = Passengers)) + 
  scale_x_discrete(name = "Month") +
  scale_y_continuous(expand = c(0, 0), name = "Year", breaks = seq(min(data$year), max(data$year), by = 1)) +
  scale_fill_gradientn(colours = rev(heat.colors(10)), labels = comma) +
  theme_minimal() +
  ggtitle("United Airlines Passengers Count") +
  format_title +
  format_legend_title
```

